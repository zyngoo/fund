{% extends "event/event_base.html" %}

{% block content %}
    <div style="margin-bottom: 5px;">
        <ins class="adsbygoogle" style="display:inline-block;" data-ad-client="ca-pub-6111334333458862"
             data-ad-slot="3820120620">
        </ins>
    </div>

    <div class="layui-btn-group demoTable">
{#        <button class="layui-btn" data-type="getCheckData">获取选中行数据</button>#}
        <button class="layui-btn" data-type="getCheckLength">获取选中数目</button>
        <button class="layui-btn" data-type="isAll">验证是否全选</button>
    </div>

    <table class="layui-table" lay-data="{ url:'/jijin/event/list_handle/', page:true, id:'idTest'}"
           lay-filter="demo">
        <thead>
        <tr>
            <th lay-data="{type:'checkbox', fixed: 'left'}"></th>
            <th lay-data="{field:'title_id', width:100, sort: true, fixed: true}">ID</th>
            <th lay-data="{field:'event_name', width:100}">标题</th>
            <th lay-data="{field:'fund_name', width:120, sort: true,edit:'text'}">关联</th>
            <th lay-data="{field:'event_type', width:120}">类型</th>
            <th lay-data="{field:'event_publisher', width:100}">发布人</th>
            <th lay-data="{field:'publish_date', width:200, sort: true}">发布日期</th>
            <th lay-data="{field:'event_status', width:100}">状态</th>
            <th lay-data="{fixed: 'right', width:180, align:'center', toolbar: '#barDemo'}"></th>
        </tr>
        </thead>
    </table>

    <div class="layui-row" id="viewData" style="display: none;">
        <form class="layui-form" method="post" action="">

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 0;">
                <legend>查看事件</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">事件名</label>
                <div class="layui-input-block">
                    <input id="event_name_2" type="text" name="event_name" autocomplete="off" class="layui-input">
                </div>
            </div>


            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">关联</label>
                    <div class="layui-input-block">
                        <input id="fund_name_2" type="text" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">类型</label>
                    <div class="layui-input-block">
                        <input id="event_type_2" type="text" class="layui-input">
                    </div>
                </div>

            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">发布人</label>
                    <div class="layui-input-block">
                        <input type="text" name="event_publisher" value="{{ request.session.user_name }}"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">发布日期</label>
                    <div class="layui-input-block">
                        <input id="publish_date_2" type="text" name="publish_date" id="date" autocomplete="on"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-block">
                        <input id="event_status_2" type="text" class="layui-input">
                    </div>
                </div>

            </div>


            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">会议摘要</label>
                <div class="layui-input-block">
                    <textarea id="event_content_2" placeholder="请输入内容" class="layui-textarea"
                              name="event_content"></textarea>
                </div>
            </div>
        </form>
    </div>

    <div class="layui-row" id="popUpdateTest" style="display:none;">
        <div class="layui-col-md10">
            <div class="layui-form" style="width: 800px">

                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 0;">
                    <legend>修改事件</legend>
                </fieldset>
                <label id="title_id" style="display:none"></label>
                <div class="layui-form-item">
                    <label class="layui-form-label">事件名</label>
                    <div class="layui-input-block">
                        <input id="event_name" type="text" name="title" autocomplete="off" placeholder="请输入事件名"
                               class="layui-input">
                    </div>
                </div>


                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">关联</label>
                        <div class="layui-input-block">
                            <select id="fund_name" name="interest1" lay-filter="aihao">

                            </select>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">类型</label>
                        <div class="layui-input-block">
                            <select id="event_type" name="interest1" lay-filter="aihao">
                                {#                                <option value="" selected=""></option>#}
                                {#                                <option value="0">股权直投</option>#}
                                {#                                <option value="1">二级市场</option>#}
                                {#                                <option value="2">地产</option>#}
                            </select>
                        </div>
                    </div>

                </div>


                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">发布人</label>
                        <div class="layui-input-block">
                            <input type="text" name="event_publisher" value="{{ request.session.user_name }}"
                                   class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">发布日期</label>
                        <div class="layui-input-block">
                            <input type="text" name="date" id="publish_date" autocomplete="on" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">状态</label>
                        <div class="layui-input-block">
                            <select id="event_status" name="interest1" lay-filter="aihao">
                                {#                                <option value="" selected=""></option>#}
                                {#                                <option value="0">股权直投</option>#}
                                {#                                <option value="1">二级市场</option>#}
                                {#                                <option value="2">地产</option>#}
                            </select>
                        </div>
                    </div>
                </div>


                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">会议摘要</label>
                    <div class="layui-input-block">
                        <textarea id="event_content" placeholder="请输入内容" class="layui-textarea"
                                  name="abstract"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        {#                        <button type="button" class="layui-btn" id="test3"><i class="layui-icon"></i>上传文件</button>#}
                        <button class="layui-btn layui-btn-submit" lay-submit="" lay-filter="demo2"
                                onclick="mysubmit()">提交
                        </button>
                        {#                        <button class="layui-btn layui-btn-primary" lay-filter type="submit" action="cache">暂存</button>#}
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>

            </div>

        </div>
    </div>

{% endblock %}

{% block script %}

    <script type="text/html" id="barDemo">
        {#	 <a class="layui-btn layui-btn-xs" lay-event="add">添加</a>#}
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>


    <script>

        function getFundData() {
            $.ajax({
                url: "/jijin/event/event_fund/",
                type: "POST",
                dataType: "json",
                async: false,
                success: function (msg) {
                    {#console.log(msg);#}
                    {#var PersonData = [];#}
                    {#for (var i = 0; i < msg.length; i++) {#}
                    {#    PersonData[PersonData.length] = msg[i]#}
                    {#;}#}
                    {#person = PersonData;#}
                    fundData = msg
                }
            });
            return fundData;
        }

        var fundData = getFundData();

        layui.use(['table', "form", "laydate"], function () {
            var table = layui.table
                , form = layui.form
                , laydate = layui.laydate;
            {#var  popForm=layui.form;#}
            //监听表格复选框选择
            table.on('checkbox(demo)', function (obj) {
                console.log(obj); //选中行的相关数据
            });
            //监听工具条
            table.on('tool(demo)', function (obj) {
                var data = obj.data;
                if (obj.event === 'detail') {
                    {#layer.msg('ID：'+ data.id + ' 的查看操作');#}
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        {#title: "查看日程",#}
                        area: ['1030px', '500px'],
                        content: $("#viewData"),//引用的弹出层的页面层的方式加载修改界面表单
                        shade: 0,
                        success: function (x, y) {

                            for (var key in data) {
                                var idName = '#' + key + "_2";
                                $(idName).val(data[key]);

                            }

                        }
                    });
                } else if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        var title_id = obj.data.title_id;
                        {#alert(index)#}
                        $.ajax({
                            url: "/jijin/event/event_delete/",
                            type: "post",
                            async: false,
                            data: {'title_id': title_id},
                            dataType: "json",
                            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',//防止乱码
                            success: function (data) {
                                if (data == 'ok') {
                                    {#alert('成功');#}
                                    layer.msg("删除成功！")
                                }
                            }

                        });
                        layer.close(index);
                    });
                } else if (obj.event === 'edit') {
                    var title_id = obj.data.title_id;
                    var value = '';
                    for (var i = 0; i < fundData.length; i++) {
                        {#alert(msg[i].fund_name);#}
                        if (obj.data.fund_name == fundData[i].fund_name) {
                            value += "<option value='" + fundData[i].fund_id + "' selected >" + fundData[i].fund_name + "</option>";
                        } else {
                            value += "<option value='" + fundData[i].fund_id + "'>" + fundData[i].fund_name + "</option>";

                        }

                    }
                    {#alert(value);#}
                    $("#fund_name").empty();
                    $("#fund_name").append(value);

                    {#类型选择#}
                    var typeList = ['任务', '事件', '大事记', '通知', '行业研究'];
                    {#var contactList_id = [0, 1, 2];#}
                    {#alert(JSON.stringify(obj.data))#}
                    var contantVal = '';
                    for (var i = 0; i < typeList.length; i++) {
                        {#alert(msg[i])#}
                        if (obj.data.event_type == typeList[i]) {
                            contantVal += "<option value='" + typeList[i] + "' selected >" + typeList[i] + "</option>";
                        } else {
                            contantVal += "<option value='" + typeList[i] + "'>" + typeList[i] + "</option>";

                        }

                    }
                    $("#event_type").empty();
                    $("#event_type").append(contantVal);


                    {#状态选择#}
                    var remindList = ["代办", "完成"];

                    var remindVal = "";
                    for (var i = 0; i < remindList.length; i++) {
                        if (obj.data.event_status == remindList[i]) {
                            remindVal += "<option value ='" + remindList[i] + "' selected >" + remindList[i] + "</option>";
                        } else {
                            remindVal += "<option value ='" + remindList[i] + "'>" + remindList[i] + "</option>";
                        }
                    }
                    $("#event_status").empty();
                    $("#event_status").append(remindVal);

                    {#表单渲染#}
                    form.render();

                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        {#title: "修改日程",#}
                        area: ['1030px', '500px'],
                        content: $("#popUpdateTest"),//引用的弹出层的页面层的方式加载修改界面表单
                        shade: 0,
                        success: function (x, y) {

                            for (var key in data) {
                                var idName = '#' + key;
                                $(idName).val(data[key]);
                            }

                        }
                    });


                    //动态向表传递赋值可以参看文章进行修改界面的更新前数据的显示，当然也是异步请求的要数据的修改数据的获取
                    //getFormValue(obj, data);
                }


            });

            //日期
            laydate.render({
                elem: '#publish_date'
            });

            var $ = layui.$, active = {
                getCheckData: function () { //获取选中数据
                    var checkStatus = table.checkStatus('idTest')
                        , data = checkStatus.data;
                    layer.alert(JSON.stringify(data));
                }
                , getCheckLength: function () { //获取选中数目
                    var checkStatus = table.checkStatus('idTest')
                        , data = checkStatus.data;
                    layer.msg('选中了：' + data.length + ' 个');
                }
                , isAll: function () { //验证是否全选
                    var checkStatus = table.checkStatus('idTest');
                    layer.msg(checkStatus.isAll ? '全选' : '未全选')
                }
            };

            $('.demoTable .layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });


        function mysubmit() {
            var title_id = $("#title_id").val();
            var event_name = $("#event_name").val();
            var event_association = $("#fund_name").val();
            var event_type = $("#event_type").val();
            var event_publisher = $('#event_publisher').val();
            var publish_date = $('#publish_date').val();
            var event_status = $('#event_status').val();
            var event_content = $('#event_content').val();

            keyword = ["title_id", "event_name", "event_association", "event_type", "event_publisher", "publish_date", "event_status", "event_content"];
            value = [title_id, event_name, event_association, event_type, event_publisher, publish_date, event_status, event_content];

            var dataSend = {};
            for (var i = 0; i < keyword.length; i++) {
                dataSend[keyword[i]] = value[i]
            }

            {#alert(JSON.stringify(dataSend));#}
            {#console.log(dataSend);#}
            {#dataSend = JSON.stringify(dataSend);#}
            $.ajax({
                url: "/jijin/event/event_edit/",
                type: "POST",
                async: false,
                dataType: "json",
                data: dataSend,
                success: function (data) {
                    {#alert('成功');#}
                    if (data === "ok") {
                        layer.msg("修改成功")
                    } else {
                        layer.msg("修改失败")
                    }
                    setTimeout(function () {
                        window.location.href = "/jijin/event/";
                    });
                    {#console.log(data)#}
                }
            })

        }


    </script>
{% endblock %}